---
title: "Kredyty hipoteczne"
author: "Czarnoksiężnicy z Oz"
date: "Opublikowane `r format(Sys.time(), "%A %d %B %Y")`"
editor_options:
  markdown:
    wrap: 72
---

```{r include=FALSE}
# Biblioteki
library(naniar)
library(dplyr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(patchwork)
library(editrules)
library(VIM)
library(tidyr)
library(mosaic)
library(ggstatsplot)
library(pROC)
library(rpart)
library(rpart.plot)
library(colorspace)
library(gridExtra)
library(cowplot)
```

## Wczytanie danych

```{r warning=FALSE}
dane <- read.csv("Hipoteczny.csv", header = TRUE)
dane[dane == ""] <- NA
dane <- as.data.frame(dane)
kable(head(dane, 10), caption = "Dane") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "auto")
```

------------------------------------------------------------------------

### Legenda

| Zmienna w tabeli  | Opis zmiennej                              |
|-------------------|--------------------------------------------|
| Loan_ID           | ID aplikanta                               |
| Gender            | Płeć                                       |
| Married           | Stan cywilny                               |
| Dependents        | Liczba osób zależnych finansowo            |
| Education         | Poziom edukacji                            |
| Self_Employed     | Samozatrudnienie                           |
| ApplicantIncome   | Dochody aplikanta                          |
| CoapplicantIncome | Dochody współaplikanta                     |
| LoanAmount        | Kwota kredytu                              |
| Loan_Amount_Term  | Okres kredytowania                         |
| Credit_History    | Historia kredytowa                         |
| Property_Area     | Położenie obiektu hipoteki                 |
| LoanStatus        | Status kredytu                             |
| TotalIncome       | Dochód całkowity                           |
| DebtToIncomeRatio | Wskaźnik zadłużenia w stosunku do dochodów |

------------------------------------------------------------------------

## WSTĘP

Autor: Dominika Szymczak

Niniejszy raport jest projektem zaliczeniowym przedmiotu Analiza Danych dla kierunku Analityka Gospodarcza II na Politechnice Gdańskiej.
Autorami są: Julia Sowińska, Dominika Szymczak oraz Mikołaj Zalewski.

Celem projektu jest identyfikacja kluczowych czynników wpływających na zatwierdzenie kredytu mieszkaniowego, analiza procesu jego zatwierdzania oraz opracowanie modelu predykcyjnego wspierającego automatyczne podejmowanie decyzji w oparciu o dane klienta.

Otrzymane dane obejmują cechy wnioskodawców, takie jak płeć, poziom edukacji, dochody, historia kredytowa, parametry kredytu oraz inne.
Analiza obejmuje eksplorację danych oraz ich wyczyszczenie i przygotowanie do analizy, identyfikację kluczowych zależności i segmentację klientów.
Na tej podstawie zostanie zbudowany model predykcyjny usprawniający proces przyznawania kredytów, który minimalizuje ryzyko ich udzielania klientom o niskiej zdolności kredytowej.

------------------------------------------------------------------------

# PRZYGOTOWANIE DANYCH

## 1. Identyfikacja brakujących danych

Autor: Dominika Szymczak

### Sprawdzenie, które kolumny zawierają brakujące wartości

```{r warning=FALSE}
miss_summary <- tibble(
  Metryka = c("Liczba braków", "Liczba pełnych wartości", "Procent braków"),
  Wartość = c(n_miss(dane), n_complete(dane), pct_miss(dane))
)
kable(miss_summary, col.names = c("Metryka", "Wartość"), caption = "Podsumowanie brakujących wratości") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r echo=FALSE, warning=FALSE}
kable(miss_var_summary(dane), caption = "Podsumowanie brakujących wratości") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

W tabeli jest 149 pustych rekordów, co stanowi 1,87% wszytskich rekordów.
Występują one w kolumnach *Historia kredytowa* (50), *Samozatrudnienie* (32), *Kwota kredytu* (22), *Liczba osób zależnych finansowo* 15), *Czas trwania kredytu* (14), *Płeć* (13) i *Stan cywilny* (3).

### Wyliczenie procentu brakujących danych w każdej kolumnie

```{r warning=FALSE}
kable(miss_case_table(dane), caption = "Podsumowanie liczby brakujących wratości w rekordach") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

480 obserwacji (z 614) jest w pełni wypełnionych (brak pustych rekordów).
Stanowi to 78,18% wszystkich obserwacji.

### Wykonanie wizualizacji braków danych

```{r message = FALSE}
vis_miss(dane, cluster = TRUE, sort_miss = TRUE) +
  labs(title = "Analiza brakujących danych")

wykres_gr <- scale_fill_gradientn(colors = c("#42cec2", "#306591", "#002185", "#0f225f", "#142c45"))

gg_miss_fct(dane, fct = Self_Employed) +
  labs(title = "Braki danych względem samozatrudnienia",
       x = "Samozatrudnienie", 
       y = "zmienne") +
  wykres_gr +
  theme_minimal()
```

Braki w *Samozatrudnieniu* mogą być efektem niepodania informacji przez aplikantów lub nieposiadania formalnego zatrudnienia.

W kwocie kredytu może brakować danych z powodu problemów z wyceną wnioskowanej kwoty w momencie wypełniania wniosku internetowego.

Kolumna *Historia kredytowa* ma największy odsetek braków w kategorii NA w *Samozatrudnieniu*.
To znaczy, że ten brak danych jest często powiązany z brakiem historii kredytowej.

------------------------------------------------------------------------

## 2. Analiza przyczyn braków

Autor: Julia Sowińska

### Analiza przecięć brakujących wartości

```{r}
gg_miss_upset(dane, nsets = 7,
              sets.bar.color = "#42cec2",
              main.bar.color = "#0f225f")
```

Wykres potwierdza poprzednie wyniki o dominacji pojedynczych zbiorach braków.

Najwięcej braków danych jest w kolumnie *Historia kredytowa* i są to braki pojedyncze, to znaczy, że z pośród wszystkich kolumn w 43 wierszach tylko kolumna *Historia kredytowa* ma NA.

```{r warning=FALSE}
kable(data.frame(
  zmienna = c("Credit_History", "Self_Employment"),
  No = c(89, 500),
  Yes = c(475, 82)),
  caption = "Tabela Historia kredytowa i Samozatrudnienie") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Patrząc na rozkład wartości w kolumnie *Historia kredytowa* oraz na liczbę brakujących wartości, nasuwa się założenie, że wartości brakujące mogą reprezentować kredytobiorców, którzy nie chcieli przyznawać się do braku historii kredytowej lub dla których bank napotkał problemy z pozyskaiem danych.

Podobnie w przypadku braków w kolumnie *Samozatrudnienie* - mogą one reprezentować kredytobiorców, którzy nie chcieli przyznawać się do samozatrudnienia lub uznali, że nie muszą oni wypełniać tej kolumny.

Tym samym, braki w tych dwóch zmiennych uznane zostają za MNAR (Missing Not at Random).

Braki w kolumnie *Kwota kredytu* mogą reprezentować klientów, który złożyli wniosek kredytowy bez konkretnej kwoty, zakładając, że kwota zostanie ustalona podczas analizy.
Co ciekawe, spośród wierszy charakteryzujących się wartością NA w kolumnie *Kwota kredytów* równo połowa ma *Status kredytu* równy Y i połowa równy N.

Braki w kolumnie *Czas trwania kredytu* sytuacja może wyglądać podobnie - mogą to być klienci, którzy nie wypełnili wartości w kolumnie, zakładając domyślne ustawienia banku.
Dlatego braki w kolumnach *Kwota kredytu* i *Czas trwania kredytu* również zostają uznane za potencjalne MNAR.

Braki w kolumnie *Płeć* mogą reprezentować osoby, które nie chciały podawać tej informacji, uznając, że płeć nie powinna mieć wpływu na decyzje kredytową.
Braki w kolumnie *Liczba osób zależnych finansowo* mogą oznaczać świadome pominięcie pytania w obawie przed negatywnym wpływem odpowiedzi na zdolność kredytową lub po prostu z braku obowiązku.
Dlatego braki zmiennej *Stan cywilny* oraz braki zmiennej *Płeć* zostają uznane za MNAR.

Wracając do wykresu przecięć wartości - kombinacje z małą liczbą braków mogą być przypadkowe i niekoniecznie oznaczają zależności.

Kombinacja między *Samozatrudnienie* i *Historia kredytowa* również występuje niewiele razy - 5.
Jednak, jako że jest to najczęściej występująca kombinacja, zostanie ona rozważona jako potencjalny związek.
Może on być związany z obawą o negatywną ocenę zdolności kredytowej (jako że samozatrudnienie jest bardziej ryzykowne) i tym samym obawą o niższej kwocie kredytu lub wyższym oprocentowaniu.
A także z trudnościami w uzyskaniu kredytów w przeszłości, co prowadzi do niekorzystnych danych w historii kredytowej.
W takim wypadku, kredytobiorcy celowo nie podawaliby statusu samozatrudnienia i składaliby prośbę o wyższe kwoty kredytu, w nadziei, że bank uzna ich za zatrudnionych na pełen etat bez historii kredytowej.

### Analiza relacji brakujących wartości

```{r warning=FALSE}
ggplot(data = dane, aes(x = Credit_History, y = LoanAmount)) +
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("#42cec2","#002185")) +
  theme_minimal() +
  labs(x = "Historia kredytowa", y = "Kwota kredytu") +
  facet_wrap(~Self_Employed, scales = "free")
```

Można zauważyć, że z pośród kredytobiorców z wartością NA w kolumnie *Samozatrudnienie* oraz w kolumnie *Historia kredytowa*, niemalże wszyscy (poza jednym przypadkiem z brakiem danych również w kolumnie *Kwota kredytu*) mają wartości w kolumnie *Kwota kredytu* powyżej 150, czyli większe niż w innych grupach.

To może być argumentem za przyjęciem tezy, że osoby, które nie odpowiedziały na pytanie o samozatrudnienie, są samozatrudnione.

------------------------------------------------------------------------

## 3. Uzupełnianie braków danych

Autor: Mikołaj Zalewski

### Decyzja o strategii postępowania z brakującymi danymi

Obseracje z brakiem danych w kolumnie *Historia kredytowa* zastąpimy wartością 0 zgodnie z naszymi wcześniejszymi wnioskami.
Obserwacje z brakiem danych w kolumnach *Płeć* i *Stan cywilny* zostaną zastąpione wartością "undefined", czyli po polsku "nieokreślone".
Każdy wniosek o kredyt jest ważny, więc usuwanie obserwacji nie jest dobrym rozwiązaniem.
Obserwacje z brakiem danych w kolumnie *Liczba osób zależnych finansowo* zostaną zastąpione wartością 0.
Dla obserwacji z brakiem danych w kolumnie *Czas trwania kredytu* można przyjąć strategię inputacji wartością, która występuje w znaczącej większości obserwacji, czyli najpopularniejszym czasem, na jaki bierze się kredyt (czyli 360 dni).
Obserwacje z brakiem danych w kolumnie *Samozatrudnienie* zgodnie z naszą wcześniej opisaną tezą zamieniamy na wartość "Yes", czyli potwierdzającą samozatrudnienie.

Obserwacje z brakiem danych w kolumnie *Kwota kredytu* uzupełnione będą za pomocą techniki Hot Deck, w której brakująca wartość zastępowana będzie wartością od klienta o najbardziej podobnych cechach.

### Przeprowadzenie powyższej strategii

```{r}
dane$Credit_History[is.na(dane$Credit_History)] <- 0
dane$Gender[is.na(dane$Gender)] <- "Undefined"
dane$Married[is.na(dane$Married)] <- "Undefined"
dane$Dependents[is.na(dane$Dependents)] <- 0
dane$Loan_Amount_Term[is.na(dane$Loan_Amount_Term)] <- 360
dane$Self_Employed[is.na(dane$Self_Employed)] <- "Yes"
dane <- hotdeck(dane, variable = "LoanAmount")
dane <- dane %>% select(-LoanAmount_imp)
```

### Weryfikacja poprawności

```{r}
n_miss(dane) 
```

W zbiorze danych nie występują już żadne puste wartości.

------------------------------------------------------------------------

## 4. Identyfikacja i usunięcie nieprawidłowych wartości

Autor: Dominika Szymczak i Julia Sowińska

Na tym etapie sprawdzić należy, czy nasz zbiór danych zawiera wartości logiczne.
Wprowadzone zostają ograniczenia dla zmiennych:

\- *Dochód aplikanta* powinna być większa lub równa 0

\- *Dochód współaplikanta* powinna być większa lub równa 0

\- *Kwota kredytu* powinna być większa od 0

\- *Okres kredytowania* powinna być większa od 0

\- *Historia kredytowa* powinna być 0 lub 1.

### Wykrycie i usunięcie/przekształcenie wartości logicznie niepoprawnych (niemożliwych) dla wartości numerycznych

```{r}
ograniczenia <- editset(c("0 <= ApplicantIncome",
                          "0 <= CoapplicantIncome",
                          "0 < LoanAmount",
                          "0 < Loan_Amount_Term"))

dane$Credit_History <- factor(dane$Credit_History, 
                               levels = c(0, 1), 
                               labels = c("Not existing", "Existing"))

summary(violatedEdits(ograniczenia, dane))

```

Dla danych numerycznych wprowadzone zostały ograniczenia:

\- dla zmiennej *Dochód aplikanta* wartości nie mogą być mniejsze niż 0

\- dla zmiennej *Dochód współaplikanta* wartości nie mogą być mniejsze niż 0

\- dla zmiennej *Wartość kredytu* wartości nie mogą być mniejsze lub równe 0

\- dla zmiennej *Okres kredytowania* wartości nie mogą być mniejsze niż 0

Dla rekordów, których wartości nie spełniały ograniczeń przypisane powinny zostać wartości NA.
Jednak w tym przypadku, wszystkie wartości zmiennych spełniały założone ograniczenia i nie ma potrzeby przeprowadzenia dalszego przekształacania tych danych.

### Wykrycie i usunięcie/przekształcenie wartości logicznie niepoprawnych (niemożliwych) dla wartości tekstowych

```{r warning=FALSE}
dane <- dane %>% mutate(
  Gender = factor(dane$Gender,
                      levels = c("Male", "Female", "Undefined"),
                      labels = c("Male", "Female", "Undefined")),
  Married = factor(dane$Married,
                       levels = c("No", "Yes", "Undefined"),
                       labels = c("No", "Yes", "Undefined")),
  Dependents = factor(dane$Dependents,
                          levels = c("0", "1", "2", "3+"),
                          labels = c("0", "1", "2", "3+")),
  Education = factor(dane$Education,
                         levels = c("Not Graduate", "Graduate"),
                         labels = c("Not Graduate", "Graduate")),
  Self_Employed = factor(dane$Self_Employed,
                             levels = c("No", "Yes"),
                             labels = c("No", "Yes")),
  Loan_Amount_Term = factor(dane$Loan_Amount_Term,
                           levels = c("12", "36", "60", "84", "120", "180", "240", "300", "360", "480"),
                           labels = c("1", "3", "5", "7", "10", "15", "20", "25", "30", "40")),
  Property_Area = factor(dane$Property_Area,
                             levels = c("Rural", "Semiurban", "Urban"),
                             labels = c("Rural", "Semiurban", "Urban")),
  Loan_Status = factor(dane$Loan_Status,
                           levels = c("N", "Y"),
                           labels = c("No", "Yes")))

kable(table(dane$Gender), caption = "Tabela częstości płci", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
kable(table(dane$Married), caption = "Tabela częstości stanu cywilnego", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(table(dane$Dependents), caption = "Tabela częstości liczby osób zależnych finansowo", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(table(dane$Education), caption = "Tabela częstości poziomu edukacji", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(table(dane$Self_Employed), caption = "Tabela częstości samozatrudnienia", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(table(dane$Loan_Amount_Term), caption = "Tabela częstości okresu kredytowania", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(table(dane$Property_Area), caption = "Tabela częstości położenia obiektu hipoteki", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(table(dane$Loan_Status), caption = "Tabela częstości statusu kredytu", col.names = c("Kategoria", "Częstość")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

Dla danych tekstowych, tak jak dla danych numerycznych nie znaleziono żadnych odstających od założeń wartości i nie ma potrzeby przeprowadzenia dalszego przekształacania tych danych.

### Sprawdzenie rozkładów zmiennych i ich statystyki opisowe

```{r warning=FALSE}
plot_variables <- list(
  "Gender" = "Rozkład Gender",
  "Married" = "Rozkład Married",
  "Dependents" = "Rozkład Dependents",
  "Education" = "Rozkład Education",
  "Self_Employed" = "Rozkład Self_Employed",
  "Loan_Amount_Term" = "Rozkład Loan_Amount_Term",
  "Credit_History" = "Rozkład Credit_History",
  "Property_Area" = "Rozkład Property_Area",
  "Loan_Status" = "Rozkład Loan_Status"
)

plot_list <- lapply(names(plot_variables), function(var) {
  ggplot(dane, aes_string(x = var)) +
    geom_bar(fill = "#306591") +
    labs(title = plot_variables[[var]], x = var, y = "Liczność")
})

num_plot_vars <- c("ApplicantIncome", "CoapplicantIncome", "LoanAmount")
num_plot_list <- lapply(num_plot_vars, function(var) {
  ggplot(dane, aes_string(x = var)) +
    geom_histogram(fill = "#306591", color = "#0f225f", bins = 30) +
    labs(title = paste("Rozkład", var), x = var, y = "Częstotliwość")
})

combined_plots <- c(plot_list, num_plot_list) %>%
  do.call(cowplot::plot_grid, .)

plot_grid(
  ggdraw() + draw_label("Rozkłady zmiennych", fontface = "bold", size = 14, hjust = 0.5),
  combined_plots,
  ncol = 1,
  rel_heights = c(0.1, 1))

```

W zmiennej *Płeć* dominującą kategorią są mężczyźni (489 przypadków), natomiast kobiet jest 112, a w 13 przypadkach płeć nie została określona.
W odniesieniu do zmiennej *Stan cywilny*, większość osób to osoby w związku małżeńskim (398), podczas gdy niezamężnych jest 213, a 3 przypadki pozostają niezdefiniowane.

Zmienna *Liczba osób zależnych finansowo* wskazuje, że najwięcej respondentów (360) nie posiada osób na utrzymaniu, 102 osoby deklarują jedną osobę na utrzymaniu, 101 osób dwie, a 51 osób trzy lub więcej.
W odniesieniu do zmiennej *Poziom edukacji*, większość osób posiada wykształcenie wyższe (480), a 134 osoby mają niższy poziom wykształcenia.

W przypadku zmiennej *Samozatrudneinie*, 500 osób zadeklarowało, że nie prowadzi działalności gospodarczej, a 114 osób to osoby samozatrudnione.
Zmienna *Dochód aplikanta*, opisująca dochód głównego wnioskodawcy, wskazuje na wartości od 150 do 81 000, przy czym mediana wynosi 3812, a średnia 5403, co wskazuje na obecność wartości odstających.
*Dochód współaplikanta* jest w wielu przypadkach równy 0 (25. percentyl to 0), co oznacza, że wiele osób nie posiada współwnioskodawcy.
Mediana wynosi 1188, średnia to 1621, a maksymalna wartość wynosi 41 667.

Zmienna *Kwota kredytu*, określająca kwotę pożyczki, ma wartości od 9 do 700, przy medianie 128 i średniej 145,8, co również sugeruje obecność wartości odstających.
*Okres kredytowania*, opisujący czas spłaty pożyczki w miesiącach, waha się od 12 do 480 miesięcy, z medianą 360 miesięcy (30 lat).

*Historia kredytowa* wskazuje, że większość wnioskodawców (około 77,4%) posiada pozytywną historię kredytową (wartość 1).
Rozkład zmiennej *Położenie obiektu hipoteki* pokazuje, że 179 obiektów znajduje się na terenach wiejskich, 233 w obszarach półmiejskich, a 202 w miastach.
Zmienna *Status kredytu*, opisująca status wniosku o pożyczkę, wskazuje, że większość wniosków (422) została zatwierdzona, a 192 odrzucono.

### Wykrycie i usunięcie/przekształcenie wartości odstających

kable(common_outliers_LoanAmount, caption = "Wartości odstające kwot kredytów") %\>%

kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```{r message=FALSE, warning=FALSE}
z_score <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

dane_outliers <- dane %>%
  mutate(
    z_score_ApplicantIncome = z_score(ApplicantIncome),
    z_score_CoapplicantIncome = z_score(CoapplicantIncome),
    z_score_LoanAmount = z_score(LoanAmount),
  )

z_outliers_ApplicantIncome <- dane_outliers[dane_outliers$z_score_ApplicantIncome > 3 | dane_outliers$z_score_ApplicantIncome < -3, ]
z_outliers_CoapplicantIncome <- dane_outliers[dane_outliers$z_score_CoapplicantIncome > 3 | dane_outliers$z_score_CoapplicantIncome < -3, ]
z_outliers_LoanAmount <- dane_outliers[dane_outliers$z_score_LoanAmount > 3 | dane_outliers$z_score_LoanAmount < -3, ]

outliers <- function(df, col) {
  Q1 <- quantile(df[[col]], 0.25, na.rm = TRUE)
  Q3 <- quantile(df[[col]], 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  bottom <- Q1 - 1.5 * IQR
  top <- Q3 + 1.5 * IQR
  df2 <- df %>%
    filter(df[[col]] < bottom | df[[col]] > top)
  return(df2)
}

iqr_outliers_ApplicantIncome <- outliers(dane_outliers, "ApplicantIncome")
iqr_outliers_CoapplicantIncome <- outliers(dane_outliers, "CoapplicantIncome")
iqr_outliers_LoanAmount <- outliers(dane_outliers, "LoanAmount")

common_outliers_ApplicantIncome <- inner_join(
  z_outliers_ApplicantIncome, iqr_outliers_ApplicantIncome)
common_outliers_CoapplicantIncome <- inner_join(
  z_outliers_CoapplicantIncome, iqr_outliers_CoapplicantIncome)
common_outliers_LoanAmount <- inner_join(
  z_outliers_LoanAmount, iqr_outliers_LoanAmount)

kable(common_outliers_ApplicantIncome, caption = "Wartości odstające dochodów aplikantów") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
kable(common_outliers_CoapplicantIncome, caption = "Wartości odstające dochodów współaplikantów") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

W celu wykrycia wartości odstających posłużono się kombinacją dwóch metod - metody Z-score (gdzie wartość jest odstająca, jeśli jej odległość od średniej w jednostkach odchylenia standardowego jest większa niż 3 lub mniejsza niż -3) oraz metoda IQR (gdzie wartość jest odstająca, jeśli znajduje się poniżej dolnej granicY Q1−1.5×IQR lub powyżej górnej granicy Q3+1.5×IQR).
Aby porównać wyniki obu metod, wybraliśmy te wiersze, które zostały uznane za wartości odstające zarówno przez metodę Z-score, jak i przez metodę IQR.

W ten sposób doszliśmy do wniosków:

\- zmienna *Dochód aplikanta* ma 8 wartości odstających, które jednak reprezentują sobą osoby o bardzo wysokich dochodach (które mogłyby być wartościowymi kredytobiorcami) - dlatego postanowiliśmy pozostawić te wartości bez zmian;

\- zmienna *Dochód współaplikanta* ma 6 wartości odstających, które reprezentują sobą osoby, których współkredytobiorca ma wysokie dochody (dochody te jednak mieszczą się w większości w średniej wartości zmiennej *Dochód aplikanta*) - dlatego te wartości też postanowiliśmy pozostawić bez zmian;

\- zmienna *Kwota kredytu* ma 15 wartości odstających, które jednak reprezentują sobą osoby składające wnioski o najwyższe kwoty kredytu (które różnież mogłyby być wartościowymi klientami firmy) - dlatego te wartości także postanowiliśmy pozostawić bez zmian.

### Niezbędne przekształcenia log-transform

```{r}
dane <- dane %>%
  mutate(
    log_ApplicantIncome = log1p(ApplicantIncome),
    log_CoapplicantIncome = log1p(CoapplicantIncome),
    log_LoanAmount = log1p(LoanAmount),
  )
log_plot_vars <- c("log_ApplicantIncome", "log_CoapplicantIncome", "log_LoanAmount")
log_plot_list <- lapply(log_plot_vars, function(var) {
  ggplot(dane, aes_string(x = var)) +
    geom_histogram(fill = "#306591", color = "#0f225f", bins = 30) +
    labs(title = paste("Rozkład", var), x = var, y = "Częstotliwość")
})

combined_plots <- log_plot_list %>%
  do.call(cowplot::plot_grid, .)
combined_plots
```

Ze względu na dużą skośność w rozkładach zmiennych *Dochód aplikanta, Dochód współaplikanta* i *Kwota kredytu* postanowiono wprowadzić także zmienne reprezentujące ich log-transformację.
Ze względu na możliwe zera w tych kolumnach, zdecydowaliśmy się na funkcję log1p() zamiast log() (log(0) jest niezdefiniowane).
Na wykresach przedstawiających rozkłady tych zlogarytmowanych zmiennych, można zauważyć, że po transformacji rozkłady te zbliżyły się zdecydowanie do rozkładu normalnego.
Jedynie w przypadku zmiennej log_CoapplicantIncome (*zlogarytmowany Dochód współaplikanta*) można nadal zauważyć dość dużą skośność, spowodowaną dużą liczbą ludzi składających wniosek o kredyt samodzielnie, lub wraz z współkredytobiorcą bez dochodów.

------------------------------------------------------------------------

## 5. Wzbogacenie danych i finalna weryfikacja

Autor: Mikołaj Zalewski

### Dodanie nowych zmiennych i sprawdzenie ich rozkładów oraz statystyk opisowych

Stworzenie zmiennej łączny przychód gospodarstwa domowego ubiegającego się o kredyt

```{r warning=FALSE}
dane$TotalIncome <- dane$ApplicantIncome + dane$CoapplicantIncome
kable(head(dane), caption = "Nowostworzona zmienna dochodu całkowitego") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "auto")
```

Stworzenie zmiennej stosunek długu do łącznych przychdów gospodarstwa domowego

```{r warning=FALSE}
dane$DebtToIncomeRatio <-dane$LoanAmount / dane$TotalIncome
kable(head(dane), caption = "Nowostworzona zmienna wskaźnika zadłużenia w stosunku do dochodu całkowitego") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "auto")

```

### Analiza warości odstających oraz potencjalnej konieczności log-transform nowych zmiennych

```{r warning=FALSE}
z_score <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
dane_outliers <- dane %>%
  mutate(
    z_score_TotalIncome = z_score(TotalIncome),
    z_score_DebtToIncomeRatio = z_score(DebtToIncomeRatio),
  )
z_outliers_TotalIncome <- dane_outliers[dane_outliers$z_score_TotalIncome > 3 | dane_outliers$z_score_TotalIncome < -3, ]
z_outliers_DebtToIncomeRatio <- dane_outliers[dane_outliers$z_score_DebtToIncomeRatio > 3 | dane_outliers$z_score_DebtToIncomeRatio < -3, ]

outliers <- function(df, col) {
  Q1 <- quantile(df[[col]], 0.25, na.rm = TRUE)
  Q3 <- quantile(df[[col]], 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  bottom <- Q1 - 1.5 * IQR
  top <- Q3 + 1.5 * IQR
  df2 <- df %>%
    filter(df[[col]] < bottom | df[[col]] > top)
  return(df2)
}
iqr_outliers_TotalIncome <- outliers(dane_outliers, "TotalIncome")
iqr_outliers_DebtToIncomeRatio <- outliers(dane_outliers, "DebtToIncomeRatio")

common_outliers_TotalIncome <- intersect(
  z_outliers_TotalIncome, iqr_outliers_TotalIncome)
common_outliers_DebtToIncomeRatio <- intersect(
  z_outliers_DebtToIncomeRatio, iqr_outliers_DebtToIncomeRatio)

kable(common_outliers_TotalIncome, caption = "Wartości odstające dochodu całkowitego") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "auto")
kable(common_outliers_DebtToIncomeRatio, caption = "Wartości odstające wskaźnika zadłużenia w stosunku do dochodu") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "auto")
```

Zmienna *Dochód całkowity* ma 10 wartości odstających, jednakże tak samo jak w przypadku zmiennych *Dochód aplikanta* oraz *Dochód współaplikanta*, są to osoby z wysokimi zarobkami więc postanwoiliśmy zostawić je bez zmian.

Zmienna *Wskaźnik zadłużenia w stosunku do dochodu* ma 8 wartości odstających, które jednak także zdecydowano pozostawić bez zmian ze względu na obawę utraty cennych informacji dotyczących podejmowania decyzji o przyznaniu kredytu.

### Przekształcenie danych log transform

```{r}
dane <- dane %>%
  mutate(
    log_TotalIncome = log1p(TotalIncome),
    log_DebtToIncomeRatio = log1p(DebtToIncomeRatio),
  )

log_plot_vars <- c("TotalIncome", "DebtToIncomeRatio")
log_plot_list <- lapply(log_plot_vars, function(var) {
  ggplot(dane, aes_string(x = var)) +
    geom_histogram(fill = "#306591", color = "#0f225f", bins = 30) +
    labs(title = paste("Rozkład", var), x = var, y = "Częstotliwość")
})

combined_plots <- log_plot_list %>%
  do.call(cowplot::plot_grid, .)
combined_plots
```

### Zapisanie przygotowanych danych do nowego pliku csv

```{r}
write.csv(dane, "DanePoprawione.csv", row.names = FALSE)
kable(head(dane, 10), caption = "Dane") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "auto")
```

------------------------------------------------------------------------

# ANALIZA DANYCH

## 1. Jednowymiarowa analiza danych

Autor: Mikołaj Zalewski

```{r}
num_vars <- c("ApplicantIncome", "CoapplicantIncome", "LoanAmount", "TotalIncome", "DebtToIncomeRatio")
num_dane_long <- dane %>%
  select(all_of(num_vars)) %>%
  pivot_longer(cols = everything(), names_to = "Zmienne", values_to = "Wartość")

cat_vars <- c("Gender", "Married", "Dependents", "Education", "Self_Employed", "Loan_Amount_Term", "Credit_History", "Property_Area", "Loan_Status")
dane_cat_long <- dane %>%
  select(all_of(cat_vars)) %>%
  pivot_longer(cols = everything(), names_to = "Zmienna", values_to = "Kategoria")

colors <- c("#42cec2", "#306591", "#002185", "#0f225f", "#142c45")
colors2 <- rep(colors, times = 5)

ggplot(num_dane_long, aes(x = Wartość, fill = Zmienne)) +
  geom_histogram(bins = 30, alpha = 0.7, color = "black") +
  facet_wrap(~Zmienne, scales = "free") +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Histogramy zmiennych numerycznych", y = "Liczność")
```

```{r}
ggplot(num_dane_long, aes(x = Zmienne, y = Wartość, fill = Zmienne)) +
  geom_boxplot() +
  facet_wrap(~Zmienne, scales = "free", ncol = 1) +
  coord_flip() +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Boxploty zmiennych numerycznych")
```

```{r}
summary_table <- sapply(dane[num_vars], summary)
summary_table <- as.data.frame(t(summary_table))
kable(summary_table, caption = "Statystyki opisowe zmiennych numerycznych") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

*Dochód wnioskodawcy* pokazuje silną asymetrię prawostronną – większość dochodów jest stosunkowo niska, ale istnieje kilka bardzo wysokich wartości.
Potwierdza to także średnia, która jest znacznie większa niż mediana.
Znaczna część wartości *dochodów współwnioskodawcy* to zero (co oznacza, że wiele osób składało wniosek o kredyt samodzielnie lub współwnioskodawca nie ma żadnego dochodu).
K*wota kredytu* oraz *całkowity dochód* mają rozkłady podobne do dochodu wnioskodawcy – większość wartości jest stosunkowo niska, ale występują duże różnice.
Wskaźnik zadłużenia do dochodu wskazuje na mocno skupione wartości, sugerując, że większość osób ma podobny stosunek zadłużenia do dochodu.

```{r}
ggplot(dane_cat_long, aes(x = Kategoria, fill = Kategoria)) +
  geom_bar() +
  facet_wrap(~Zmienna, scales = "free") +
  scale_fill_manual(values = colors2) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Wykresy częstości dla zmiennych kategorycznych", 
       x = "Kategoria", 
       y = "Liczność")
```

Większość wnioskodawców to mężczyźni z wykształceniem wyższym w związku małżeńskim bez osób na utrzymaniu.
Wnioskodawcy są dość równomiernie podzieleni między obszary: wiejski (Rural), pół-miejski (Semiurban) i miejski (Urban).
Zdecydowana większość osób to pracownicy etatowi, a osoby samozatrudnione stanowią niewielki procent.
Większość osób ma istniejącą historię kredytową i wybiera okres spłaty równy 360 miesięcy (30 lat).
Większości osób kredyt został przyznany.

## 2. Dwuwymiarowa analiza danych

Autor: Dominika Szymczak

### Dwuwymiarowa analiza zmiennych jakościowych:

-   **Status kredytu vs płeć**

```{r}
tabela <- table(dane$Loan_Status, dane$Gender)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Płeć") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Płeć")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Płeć",
       x = "Status kredytu", y = "Płeć", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczbę osób w poszczególnych kategoriach *płci* w podziale na *status kredytu* (No, Yes).
Kolorystyka wskazuje liczność poszczególnych grup – im ciemniejszy kolor, tym większa liczba obserwacji.
Najwięcej aplikacji kredytowych pochodzi od mężczyzn, co sugeruje, że są oni dominującą grupą w badanej próbie.
Nie ma widocznych znaczących różnic między kategoriami Male i Female pod względem proporcji decyzji kredytowych – obie płcie wydają się być traktowane podobnie przez instytucję kredytową.

Wykres mozaikowy przedstawia proporcje między *płcią* a *statusem kredytu*.
Każdy prostokąt odpowiada konkretnej kombinacji wartości (Male-Yes, Female-No itd.), a jego wielkość odzwierciedla liczność danej grupy.
Wartości standaryzowanych reszt nie wskazują na istotne odchylenia od wartości oczekiwanych, co oznacza, że *płeć* prawdopodobnie nie ma istotnego wpływu na decyzję kredytową.

-   **Status kredytu vs stan cywilny**

```{r}
tabela <- table(dane$Loan_Status, dane$Married)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Stan cywilny") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Stan cywilny")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Stan cywilny",
       x = "Status kredytu", y = "Stan cywilny", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczbę osób w poszczególnych kategoriach *stanu cywilnego* w podziale na *status kredytu* (No, Yes).
Najwięcej aplikacji kredytowych pochodzi od ludzi w związach małżeńskim, co sugeruje, że są oni dominującą grupą w badanej próbie.
Nie ma widocznych znaczących różnic między kategoriami *stanu cywilnego* pod względem proporcji decyzji kredytowych.

Wykres mozaikowy przedstawia proporcje między *stanem cywilnym* a *statusem kredytu*.
Wartości standaryzowanych reszt nie wskazują na istotne odchylenia od wartości oczekiwanych, co oznacza, że *stan cywilny* prawdopodobnie nie ma istotnego wpływu na decyzję kredytową.

-   **Status kredytu vs liczba osób zależnych finansowo**

```{r}
tabela <- table(dane$Loan_Status, dane$Dependents)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Liczba osób zależnych finansowo") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Liczba osób zależnych finansowo")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Liczba osób zależnych finansowo",
       x = "Status kredytu", y = "Liczba osób zależnych finansowo", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczbę osób z określoną *liczbą osób zależnych finansowo* w podziale na *status kredytu* (No, Yes).
Najwięcej aplikacji kredytowych pochodzi od osób bez osób zależnych finansowo, co sugeruje, że są oni dominującą grupą w badanej próbie.

Wykres mozaikowy przedstawia proporcje między *liczbą osób zależnych finansowo* a *statusem kredytu*.
Wartości standaryzowanych reszt nie wskazują na istotne odchylenia od wartości oczekiwanych, co oznacza, że *liczba osób zależnych finansowo* prawdopodobnie nie ma istotnego wpływu na decyzję kredytową.

-   **Status kredytu vs poziom edukacji**

```{r}
tabela <- table(dane$Loan_Status, dane$Education)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Poziom edukacji") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Poziom edukacji")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Poziom edukacji",
       x = "Status kredytu", y = "Poziom edukacji", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczbę osób w poszczególnych kategoriach *poziomu edukacji* w podziale na *status kredytu*.
Najwięcej aplikacji kredytowych pochodzi od osób z wykształceniem wyższym, co sugeruje, że są oni dominującą grupą w badanej próbie.
Nie ma widocznych znaczących różnic między kategoriami pod względem proporcji decyzji kredytowych.

Wykres mozaikowy przedstawia proporcje między *poziomem edukacji* a *statusem kredytu*.
Wartości standaryzowanych reszt nie wskazują na istotne odchylenia od wartości oczekiwanych, co oznacza, że *poziom edukacji* prawdopodobnie nie ma istotnego wpływu na decyzję kredytową.

-   **Status kredytu vs samozatrudnienie**

```{r}
tabela <- table(dane$Loan_Status, dane$Self_Employed)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Samozatrudnienie") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Samozatrudnienie")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Samozatrudnienie",
       x = "Status kredytu", y = "Samozatrudnienie", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczbę osób *samozatrudnionych* i nie w podziale na *status* *kredytu*.
Najwięcej aplikacji kredytowych pochodzi od osób nie będących samozatrudnionymi, co sugeruje, że są oni dominującą grupą w badanej próbie.
Nie ma widocznych znaczących różnic między kategoriami pod względem proporcji decyzji kredytowych.

Wykres mozaikowy przedstawia proporcje między byciem *samozatrudnionym* a *statusem kredytu*.
Wartości standaryzowanych reszt nie wskazują na istotne odchylenia od wartości oczekiwanych, co oznacza, że *samozatrudnienie* prawdopodobnie nie ma istotnego wpływu na decyzję kredytową.

-   **Status kredytu vs okres kredytowania**

```{r}
tabela <- table(dane$Loan_Status, dane$Loan_Amount_Term)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Okres kredytowania") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Okres kredytowania")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Okres kredytowania",
       x = "Status kredytu", y = "Okres kredytowania", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczbę osób w poszczególnych kategoriach *okresu kredytowania* w podziale na *status* *kredytu*.
Najwięcej aplikacji kredytowych dotyczy okresu 30 lat, co sugeruje, że jest to dominujący okres kredytowania w badanej próbie.

Wykres mozaikowy przedstawia proporcje między *okresem kredytowania* a *statusem kredytu*.
Wartości standaryzowanych reszt nie wskazują na istotne odchylenia od wartości oczekiwanych, co oznacza, że *okres kredytowania* prawdopodobnie nie ma istotnego wpływu na decyzję kredytową, jednak ze względu na dużą liczbę kategorii oraz małe częstości poszczególnych kategorii, wykres może wprowadzać w błąd.

-   **Status kredytu vs historia kredytowa**

```{r}
tabela <- table(dane$Loan_Status, dane$Credit_History)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Historia kredytowa") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs historia kredytowa")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Historia kredytowa",
       x = "Status kredytu", y = "Historia kredytowa", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczebność przypadków dla osób posiadających *historię* *kredytową* i nie oraz pokazuje, że są znaczące różnice między tymi kategoriami pod względem proporcji decyzji kredytowych.

Wykres mozaikowy przedstawia reszty standaryzowane (standardized residuals), które pokazują różnice między obserwowaną a oczekiwaną liczebnością w poszczególnych kategoriach.
Kolor niebieski wskazuje, że w tych kategoriach liczba obserwacji jest większa, a kolor czerwony, że liczba obserwacji jest mniejsza niż oczekiwana.
Wykres ten sugeruje więc, że *historia* *kredytowa* może mieć istotny wpływ na decyzję kredytową.

-   **Status kredytu vs położenie obiektu hipoteki**

```{r}
tabela <- table(dane$Loan_Status, dane$Property_Area)
df_table <- as.data.frame.matrix(tabela)
kable(df_table, caption = "Tabela krzyżowa: Status kredytu vs Położenie obiektu hipoteki") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
mosaicplot(tabela, shade = TRUE, main = "Wykres Mozaikowy: Status kredytu vs Położenie obiektu hipoteki")

ggplot(as.data.frame(tabela), aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(title = "Wykres Ilościowy: Status kredytu vs Położenie obiektu hipoteki",
       x = "Status kredytu", y = "Położenie obiektu hipoteki", fill = "Liczność") +
  wykres_gr
```

Wykres ilościowy przedstawia liczebność przypadków dla różnych kategorii *położenia* *obiektu* *hipoteki* i pokazuje, że występują różnice między tymi kategoriami pod względem proporcji decyzji kredytowych.

Wykres mozaikowy przedstawia reszty standaryzowane (standardized residuals), które pokazują różnice między obserwowaną a oczekiwaną liczebnością w poszczególnych kategoriach.
Kolor czerwony wskazuje, że liczba obserwacji jest mniejsza niż oczekiwana.
Wykres ten sugeruje więc, że *położenie* *obiektu* *hipoteki* kredytowa może mieć statystycznie istotny wpływ na decyzję kredytową.

### Dwuwymiarowa analiza zmiennych mieszanych (jakościowej z ilościową)

-   **Status kredytu vs dochody aplikanta**

```{r}
wykres1 <- ggplot(dane, aes(x = Loan_Status, y = log_ApplicantIncome, fill = Loan_Status)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  labs(title = "Klasyczny wykres pudełkowy", x = "Status kredytu", y = "Dochody aplikanta") +
  theme_minimal()

wykres2 <- ggplot(dane, aes(x = Loan_Status, y = log_ApplicantIncome, fill = Loan_Status)) +
  geom_jitter(aes(color = Loan_Status), width = 0.2, height = 0, alpha = 0.6) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  scale_color_manual(values = c("No" = "#002246", "Yes" = "#002246")) +
  labs(title = "Boxplot z rzeczywistymi danymi",
       x = "Status kredytu",
       y = "Dochody aplikanta") +
  theme_minimal()

wykres1 + wykres2 + plot_layout(ncol = 2)
```

Na klasycznym wykresie pudełkowym można zauważyć, że *dochody osób*, którym przyznano kredyt, są podobne do dochodów osób, którym go odmówiono – nie ma wyraźnej różnicy w medianie i rozstępie kwartylowym.

Boxplot z rzeczywistymi danymi jest klasycznym wykresem pudełkowym wzbogaconym o rzeczywiste dane w postaci kropek, dzięki czemu można zobaczyć rzeczywisty rozkład *dochodów*, a nie tylko statystyki opisowe.
Widać, że rozkład dochodów jest zbliżony dla obu grup, co potwierdza brak wyraźnego związku między *wysokością dochodów* a *przyznaniem kredytu*.
W obu grupach występują wartości odstające, ale ich liczba i zakres są podobne.

-   **Status kredytu vs kwota kredytu**

```{r}
wykres1 <- ggplot(dane, aes(x = Loan_Status, y = log_LoanAmount, fill = Loan_Status)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  labs(title = "Klasyczny wykres pudełkowy", x = "Status kredytu", y = "Kwota kredytu") +
  theme_minimal()

wykres2 <- ggplot(dane, aes(x = Loan_Status, y = log_LoanAmount, fill = Loan_Status)) +
  geom_jitter(aes(color = Loan_Status), width = 0.2, height = 0, alpha = 0.6) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  scale_color_manual(values = c("No" = "#002246", "Yes" = "#002246")) +
  labs(title = "Boxplot z rzeczywistymi danymi",
       x = "Status kredytu",
       y = "Kwota kredytu") +
  theme_minimal()

wykres1 + wykres2 + plot_layout(ncol = 2)
```

Na klasycznym wykresie pudełkowym można zauważyć, że *kwoty kredytów*, które zostały przyznane, są podobne do kwot kredytów, które nie zostały przyznane – nie ma wyraźnej różnicy w medianie i rozstępie kwartylowym.

Boxplot z rzeczywistymi danymi pokazuje, że rozkład *kwot kredytów* jest zbliżony dla obu grup, co potwierdza brak wyraźnego związku między *kwotą kredytu* a *przyznaniem kredytu*.

-   **Status kredytu vs dochód całkowity**

```{r}
wykres1 <- ggplot(dane, aes(x = Loan_Status, y = log_TotalIncome, fill = Loan_Status)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  labs(title = "Klasyczny wykres pudełkowy", x = "Status kredytu", y = "Dochód całkowity") +
  theme_minimal()

wykres2 <- ggplot(dane, aes(x = Loan_Status, y = log_TotalIncome, fill = Loan_Status)) +
  geom_jitter(aes(color = Loan_Status), width = 0.2, height = 0, alpha = 0.6) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  scale_color_manual(values = c("No" = "#002246", "Yes" = "#002246")) +
  labs(title = "Boxplot z rzeczywistymi danymi",
       x = "Status kredytu",
       y = "Dochód całkowity") +
  theme_minimal()

wykres1 + wykres2 + plot_layout(ncol = 2)
```

Na klasycznym wykresie pudełkowym można zauważyć, że *dochody całkowite osób*, którym przyznano kredyt, są podobne do dochodów całkowitych osób, którym zostały on odmówiony – nie ma wyraźnej różnicy w medianie i rozstępie kwartylowym.

Boxplot z rzeczywistymi danymi pokazuje, że rozkład *dochodów całkowitych* jest zbliżony dla obu grup, co potwierdza brak wyraźnego związku między *wysokością dochodów* a *przyznaniem kredytu*.
Logika jednak podpowiada, że zależność taka powinna występować.

-   **Status kredytu vs wskaźnik zadłużenia w stosunku do dochodu**

```{r}
wykres1 <- ggplot(dane, aes(x = Loan_Status, y = log_DebtToIncomeRatio, fill = Loan_Status)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  labs(title = "Klasyczny wykres pudełkowy", x = "Status kredytu", y = "Wskaźnik zadłużenia w stosunku do dochodu") +
  theme_minimal()

wykres2 <- ggplot(dane, aes(x = Loan_Status, y = log_DebtToIncomeRatio, fill = Loan_Status)) +
  geom_jitter(aes(color = Loan_Status), width = 0.2, height = 0, alpha = 0.6) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  scale_fill_manual(values = c("No" = "#42cec2", "Yes" = "#002185")) + 
  scale_color_manual(values = c("No" = "#002246", "Yes" = "#002246")) +
  labs(title = "Boxplot z rzeczywistymi danymi",
       x = "Status kredytu",
       y = "Wskaźnik zadłużenia w stosunku do dochodu") +
  theme_minimal()

wykres1 + wykres2 + plot_layout(ncol = 2)
```

Na klasycznym wykresie pudełkowym można zauważyć, że *wskaźnik zadłużenia w stosunku do dochodów* osób, którym przyznano kredyt, są podobne do takiego wskaźnika osób, którym zostały on odmówiony – nie ma wyraźnej różnicy w medianie i rozstępie kwartylowym.

Boxplot z rzeczywistymi danymi pokazuje, że rozkład wskaźników zadłużenia w stosunku do dochodów jest zbliżony dla obu grup, co potwierdza brak wyraźnego związku między tą zmienną a *przyznaniem* *kredytu*.
Logika jednak podpowiada, że zależność taka powinna występować.

## 3. Budowanie i testowanie hipotez

Autor: Julia Sowińska

Dla wszystkich postawionych hipotez, przyjmuje się poziom istotności alpha w wysokości 0,05 (5%).

### Hipotezy:

#### A. Status kredytu i historia kredytowa

H₀: Prawdopodobieństwo *przyznania kredytu* (Loan_Status) jest niezależne od posiadania *historii* *kredytowej* (Credit_History).

H₁: Prawdopodobieństwo *przyznania* *kredytu* różni się w zależności od posiadania *historii kredytowej*.

```{r}
h <- table(dane$Loan_Status, dane$Credit_History)
kable(as.data.frame.matrix(h), caption = "Tabela krzyżowa: Status kredytu vs Historia kredytowa") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Założenie o minimalnej liczbie 5 obserwacji w każdej komórce tabeli kontyngencji (założenie testu chi-kwadrat), jest spełnione, dlatego zostanie wykorzystany test Chi-kwadrat.

```{r}
chi_kwadrat <- chisq.test(h)
print(chi_kwadrat)
```

P-value jest mniejsze niż przyjęty poziom istotności, co pozwala odrzucić hipotezę zerową i przyjąć hipotezę alternatywną o istnieniu zależności między *statusem kredytu* a *historią kredytowania*.

```{r}
n <- sum(h)
phi_cramer <- sqrt(chi_kwadrat$statistic / (n * (min(dim(h)) - 1)))
names(phi_cramer) <- "Cramer's V"
print(phi_cramer)
```

Współczynnik Cramera przyjmuje wartość w przybliżeniu 0,428, co świadczy o umiarkowanym związku między zmiennymi Loan_Status i Credit_History.

```{r}
ggbarstats(data = dane, x = Credit_History, y = Loan_Status, xlab = "Status kredytu", legend.title = "Historia kredytowa", package = "Redmonder", palette = "qMSOBu")
```

Wykres przedstawia zależność między posiadaniem *historii kredytowej* a *przyznaniem kredytu*.
Posiadanie historii kredytowej znacznie zwiększa szanse na uzyskanie kredytu, co sugeruje, że instytucje finansowe silnie uwzględniają ten czynnik w ocenie ryzyka kredytowego.

#### B. Status kredytu i okres kredytowania

H₀: *Okres kredytowania* (Loan_Amount_Term) nie wpływa na decyzję o *przyznaniu kredytu*.

H₁: *Okres kredytowania* wpływa na decyzję o *przyznaniu kredytu*.

```{r}
h <- table(dane$Loan_Status, dane$Loan_Amount_Term)
kable(as.data.frame.matrix(h), caption = "Tabela krzyżowa: Status kredytu vs Okres kredytowania") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Założenie o minimalnej liczbie 5 oczekiwanych obserwacji w każdej komórce tabeli kontyngencji (założenie testu chi-kwadrat), nie jest spełnione, więc wykorzystany zostanie test Fishera.

```{r}
fisher_test <- fisher.test(h)
print(fisher_test)
```

P-value jest większe niż przyjęty poziom istotności, co oznacza brak podstaw do odrzucenia hipotezy zerowej o braku zależności między *statusem* a *czasem trwania kredytu*.

```{r}
ggbarstats(data = dane, x = Loan_Amount_Term, y = Loan_Status, test = "fisher", xlab = "Status kredytu", legend.title = "Okres kredytowania", package = "Redmonder", palette = "qMSOBu")
```

Wykres przedstawia brak zależności między wybranym *okresem kredytowania* a *przyznaniem kredytu*.

#### C. Status kredytu i położenie obiektu hipoteki

H₀: *Położenie obiektu hipoteki* (Property_Area) nie wpływa na decyzję o *przyznaniu kredytu*.

H₁: *Położenie obiektu hipoteki* wpływa na decyzję o *przyznaniu kredytu*.

```{r}
h <- table(dane$Loan_Status, dane$Property_Area)
kable(as.data.frame.matrix(h), caption = "Tabela krzyżowa: Status kredytu vs Położenie obiektu hipoteki") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Założenie o minimalnej liczbie 5 oczekiwanych obserwacji w każdej komórce tabeli kontyngencji (założenie testu chi-kwadrat), jest spełnione, dlatego zostanie wykorzystany test Chi-kwadrat.

```{r}
chi_kwadrat <- chisq.test(h)
print(chi_kwadrat)
```

P-value jest mniejsze niż przyjęty poziom istotności, co pozwala odrzucić hipotezę zerową i przyjąć hipotezę alternatywną o istnieniu zależności między *statusem kredytu* a *położeniem obiektu hipoteki*.

```{r}
n <- sum(h)
phi_cramer <- sqrt(chi_kwadrat$statistic / (n * (min(dim(h)) - 1)))
names(phi_cramer) <- "Cramer's V"
print(phi_cramer)
```

Współczynnik Cramera przyjmuje wartość w przybliżeniu 0,142, co świadczy o słabym związku między *statusem kredytu* a *położeniem obiektu hipoteki*.

```{r}
ggbarstats(data = dane, x = Property_Area, y = Loan_Status, xlab = "Status kredytu", legend.title = "Położenie obiektu hipoteki", package = "Redmonder", palette = "qMSOBu")
```

Wykres przedstawia zależność między *położeniem obiektu hipoteki* a *przyznaniem kredytu*.
Położenie obiektu hipoteki w obszarze pół-miejskim znacznie zwiększa szanse na uzyskanie kredytu.

#### D. Status kredytu i wskaźnik zadłużenia w stosunku do dochodu

H₀: Średni *wskaźnik zadłużenia w stosunku do dochodu* (DebtToIncomeRatio) nie różni się między grupami, którym przyznano i nie przyznano kredytu.

H₁: Średni *wskaźnik zadłużenia w stosunku do dochodu* różni się między grupami, którym przyznano i nie przyznano kredytu.

```{r}
group_yes <- dane$log_DebtToIncomeRatio[dane$Loan_Status == "Yes"]
group_no <- dane$log_DebtToIncomeRatio[dane$Loan_Status == "No"]

shapiro_yes <- shapiro.test(group_yes)
shapiro_no <- shapiro.test(group_no)

cat("Grupa, której przyznano kredyt: W =", shapiro_yes$statistic, ", p =", shapiro_yes$p.value, "\n")
cat("Grupa, której nie przyznano kredytu: W =", shapiro_no$statistic, ", p =", shapiro_no$p.value, "\n")

bartlett_test <- bartlett.test(DebtToIncomeRatio ~ Loan_Status, data = dane)
print(bartlett_test)
```

Zarówno założenie o normalności rozkładu zmiennej reprezentującej wskaźnik zadłużenia w stosunku do dochodu w każdej z grup statusu kredytu (Yes/No), jak i założenie o jednorodności wariancji nie zostały spełnione, dlatego zamiast testu t-Studenta, stosowany będzie test U Manna-Whitneya.

```{r}
mannwhitney <- wilcox.test(log_DebtToIncomeRatio ~ Loan_Status, data = dane)
  print(mannwhitney)
```

P-value jest większe niż przyjęty poziom istotności, co oznacza brak podstaw do odrzucenia hipotezy zerowej o braku zależności między *statusem kredytu* a *Wskaźnikiem zadłużenia w stosunku do dochodu*.

#### E. Status kredytu i dochód całkowity

H₀: Średni *całkowity dochód* (TotalIncome) nie różni się między grupami, którym przyznano i nie przyznano kredytu.

H₁: Średni *całkowity dochód* różni się między grupami, którym przyznano i nie przyznano kredytu.

```{r}
group_yes <- dane$log_TotalIncome[dane$Loan_Status == "Yes"]
group_no <- dane$log_TotalIncome[dane$Loan_Status == "No"]

shapiro_yes <- shapiro.test(group_yes)
shapiro_no <- shapiro.test(group_no)

cat("Grupa, której przyznano kredyt: W =", shapiro_yes$statistic, ", p =", shapiro_yes$p.value, "\n")
cat("Grupa, której nie przyznano kredytu: W =", shapiro_no$statistic, ", p =", shapiro_no$p.value, "\n")

bartlett_test <- bartlett.test(log_TotalIncome ~ Loan_Status, data = dane)
print(bartlett_test)
```

Zarówno założenie o normalności rozkładu całkowitego dochodu w każdej z grup Loan_Status (Yes/No), jak i założenie o jednorodności wariancji nie zostały spełnione, dlatego zamiast testu t-Studenta, stosowany będzie test U Manna-Whitneya.

```{r}
mannwhitney <- wilcox.test(log_TotalIncome ~ Loan_Status, data = dane)
  print(mannwhitney)
```

P-value jest większe niż przyjęty poziom istotności, co oznacza brak podstaw do odrzucenia hipotezy zerowej o braku zależności między *statusem kredytu* a *Dochodem całkowitym*.

Zależność zmiennych dotyczących posiadania *Historii kredytowej* oraz *Położenia obiektu hipoteki* ze zmienną dotyczącą *Przyznania kredytu* zostały uznane za istotne.

## 4. Grupy klientów według kombinacji *Historii kredytowej* i *Położenie obiektu hipoteki*

Autor: Mikołaj Zalewski

### Dodanie nowej zmiennej grupującej klientów według zmiennych *Historia kredytowa* i *Położenie obiektu hipoteki* na 6 grup

```{r}
dane$Group <- paste(dane$Property_Area, dane$Credit_History, sep = "_")
dane$Group <- factor(dane$Group,
                          levels = c("Urban_Existing", "Semiurban_Existing", "Rural_Existing", "Urban_Not existing", "Semiurban_Not existing", "Rural_Not existing"),
                          labels = c("Urban_Existing", "Semiurban_Existing", "Rural_Existing", "Urban_Not existing", "Semiurban_Not existing", "Rural_Not existing"))
```

### Skrócone statystyki opisowe dla każdej grupy

```{r}
statystyki <- dane %>%
  group_by(Group) %>%
  summarise(
    Liczba_osob = n(),
    Procent_mezczyzn = (sum(Gender == "Male", na.rm = TRUE) / Liczba_osob) * 100,
    Procent_married = (sum(Married == "Yes", na.rm = TRUE) / Liczba_osob) * 100,
    Procent_Graduate = (sum(Education == "Graduate", na.rm = TRUE) / Liczba_osob) * 100,
    Srednia_TotalIncome = mean(TotalIncome, na.rm = TRUE)
  )

kable(statystyki, caption = "Porównanie grup aplikantów") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Tabela pokazuje, jak podobne pod względem innych zmiennych są poszczególne grupy.

### Proporcje przyznanych kredytów w każdej grupie

```{r}
proporcje_loan_status <- dane %>%
  group_by(Group, Loan_Status) %>%
  summarise(Liczba = n(), .groups = "drop") %>%
  group_by(Group) %>%
  mutate(Proporcja = Liczba / sum(Liczba) * 100)

ggplot(proporcje_loan_status, aes(x = "", y = Proporcja, fill = Loan_Status)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") + 
  facet_wrap(~ Group) +  
  theme_void() +  
  labs(title = "Proporcja osób, które otrzymały kredyt w każdej grupie") +
  scale_fill_manual(values = c("#42cec2", "#306591")) + 
  geom_text(aes(label = paste0(round(Proporcja, 1), "%")), position = position_stack(vjust = 0.5), color = "#142c45") 
```

## 5. Model predykcyjny

Autor: Julia Sowińska

### Podział danych na zbiór treningowy i testowy

```{r}
dane$Loan_Status_Binary <- ifelse(dane$Loan_Status == "Yes", 1, 0)
set.seed(123)
train_idx <- sample(1:nrow(dane), 0.7 * nrow(dane))
train <- dane[train_idx, ]
test <- dane[-train_idx, ]
```

Dane zostały podzielona na dwa zbiory - treningowy i testowy, by uniknąć przeuczenia (overfittingu) oraz zapewnić rzetelną ocenę modelu poprzez testowanie modelu na danych, których nie widział podczas treningu.
Zdecydowano się na podział: 70% danych do treningu i 30% danych do testu.

### Budowa modelu

```{r}
model <- glm(Loan_Status_Binary ~ Credit_History + Property_Area, data = train, family = "binomial")
summary(model)
```

Zbudowany został model regresji logistycznej (logit), który był naturalnym wyborem dla problemu klasyfikacji binarnej, jakim było przyznanie bądź nieprzyznanie kredytu.
Model ten został wybrany ze względu na jego prostotę, szybkość i efektywność, a także ze względu na łatwiejszą interpretację.
Jest to model predykcyjny, zatem zdecydowano się na pozostawienie w nim wszystkich zmiennych bez względu na istotność statystyczną.

### Ocena modelu

```{r}
predictions <- predict(model, newdata = test, type = "response")
predicted_classes <- ifelse(predictions > 0.5, "Yes", "No")
confusion_matrix <- table(Predicted = predicted_classes, Actual = test$Loan_Status)

confusion_matrix_df <- as.data.frame(confusion_matrix)
ggplot(confusion_matrix_df, aes(Actual, Predicted, fill = Freq)) +
  geom_tile() +
  theme_minimal() +
  labs(x = "Rzeczywista klasa", y = "Przewidywana klasa", fill = "Liczba") +
  wykres_gr
```

Wykres przedstawia tablicę kontyngencji i pokazuję, że prognozy dotyczące *przyznania kredytu* (rzeczywisty Credit_Status == "Yes) były dużo bardziej trafne, niż te dotyczące nie przyznania kredytu, co może sugerować, że model powinien obejmować jeszcze inne zmienne.

```{r}
accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
cat("Dokładność:", accuracy, "\n")
precision <- confusion_matrix["Yes", "Yes"] / (confusion_matrix["Yes", "Yes"] + confusion_matrix["No", "Yes"])
cat("Precyzja:", precision, "\n")
recall <- confusion_matrix["Yes", "Yes"] / (confusion_matrix["Yes", "Yes"] + confusion_matrix["Yes", "No"])
cat("Czułość:", recall, "\n")

f1_score <- 2 * (precision * recall) / (precision + recall)
cat("F1-score:", f1_score, "\n")
```

Model prawidłowo klasyfikuje około 75,68% przypadków.
Około 88,46% przewidywań przyznania kredytu jest prawidłowe i około 79,31% rzeczywistych przyznań kredytu zostało poprawnie wykrytych.
F1-score wynosi około 0,84, co oznacza, że model jest dobrze wyważony między precyzją a czułością.

```{r}
roc_curve <- roc(test$Loan_Status, predictions)
plot(roc_curve, col = "#002185")
auc(roc_curve)
```

AUC przyjmuje wartość 0,7614, co oznacza, że model jest przyzwoity.

# Podsumowanie

Autor: Julia Sowińska

Analiza danych kredytowych ujawniła kilka istotnych wzorców dotyczących decyzji kredytowych oraz czynników mogących wpływać na ich przyznawanie.
Najważniejszym czynnikiem wpływającym na decyzję kredytową jest posiadanie historii kredytowej, co sugeruje, że instytucje finansowe w dużym stopniu opierają się na wcześniejszych zobowiązaniach klienta przy ocenie jego wiarygodności.
Położenie obiektu hipoteki może również wpływać na decyzję, ale w mniejszym stopniu.
Pozostałe zmienne, takie jak dochody, wskaźnik zadłużenia czy poziom edukacji, nie wykazują istotnych zależności.
Wyniki analizy dostarczają istotnych informacji dla instytucji kredytowych, które mogą pozwolić na automatyzację procesu podejmowania decyzji o przyznaniu lub nieprzyznaniu kredytu hipotecznego.
